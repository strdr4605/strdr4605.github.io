---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import AnimatedName from '../components/AnimatedName.astro';
import DateComponent from '../components/Date.astro';
import PostFooter from '../components/PostFooter.astro';
import GiscusComments from '../components/GiscusComments.astro';

const siteUrl = 'https://strdr4605.com';

export async function getStaticPaths() {
  // Include all posts (including drafts) - drafts are just hidden from home page
  const posts = await getCollection('posts');
  return posts.map((post) => {
    const slug = post.data.slug;
    return {
      params: { slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const slug = post.data.slug;
const ogImage = `${siteUrl}/${post.data.banner || slug + '.jpg'}`;
const { Content } = await render(post);
---

<BaseLayout
  title={post.data.title}
  description={post.data.description ?? undefined}
  ogImage={ogImage}
  ogType="article"
  canonicalUrl={`${siteUrl}/${slug}`}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: post.data.title,
      description: post.data.description,
      datePublished: post.data.date.toISOString(),
      url: `${siteUrl}/${slug}`,
      image: ogImage,
      author: {
        '@type': 'Person',
        name: 'Dragoș Străinu',
        url: siteUrl,
      },
      keywords: post.data.tags,
    })}
  />
  <article>
    <h1>{post.data.title}</h1>
    <DateComponent date={post.data.date} />
    {' on '}
    <a href="/">
      <AnimatedName />'s blog
    </a>
    <br />
    {post.data.tags.length > 0 && (
      <span class="post-tags">
        {post.data.tags.map((tag, i) => (
          <>
            <a href={`/tags/${tag}`}>#{tag}</a>{i < post.data.tags.length - 1 && ', '}
          </>
        ))}
      </span>
    )}
    <Content />
    <PostFooter />
  </article>
  <GiscusComments />
</BaseLayout>
